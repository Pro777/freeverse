---
type Props = {
  currentPath?: string;
};

const { currentPath } = Astro.props;
const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const nav = [
  { href: `${base}`, label: "Home", key: "/" },
  { href: `${base}browse/`, label: "Explore poems", key: "/browse" },
  { href: `${base}search/`, label: "Search", key: "/search" },
];

const normalized = (p?: string) => {
  if (!p) return "";
  // remove trailing slash (except root)
  if (p.length > 1 && p.endsWith("/")) return p.slice(0, -1);
  return p;
};

const here = normalized(currentPath);
---

<header class="header">
  <div class="brand">
    <a href={`${base}`}>
      <div class="brand-title">Freeverse</div>
      <div class="brand-subtitle">Public-domain poetry, pleasantly readable</div>
      <div class="brand-motto">
        <a href={`${base}share/horace/odes-3-30-exegi-monumentum/6-6/`}>Non omnis moriar</a>
      </div>
    </a>
  </div>

  <nav class="nav" aria-label="Primary">
    {nav.map((item) => (
      <a href={item.href} aria-current={here === item.key ? "page" : undefined}>
        {item.label}
      </a>
    ))}

    <button class="theme-toggle" type="button" id="theme-toggle" aria-label="Toggle theme">
      Theme
    </button>
  </nav>

  <script is:inline>
    (() => {
      const STORAGE_KEY = 'freeverse-theme';
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;

      const apply = (mode) => {
        const root = document.documentElement;
        if (mode === 'light' || mode === 'dark') root.dataset.theme = mode;
        else delete root.dataset.theme;

        const label = mode === 'system' ? 'System' : mode[0].toUpperCase() + mode.slice(1);
        btn.textContent = `Theme: ${label}`;
      };

      const getStored = () => {
        try {
          return localStorage.getItem(STORAGE_KEY) || 'system';
        } catch {
          return 'system';
        }
      };

      const cycle = (mode) => {
        if (mode === 'system') return 'light';
        if (mode === 'light') return 'dark';
        return 'system';
      };

      let mode = getStored();
      apply(mode);

      btn.addEventListener('click', () => {
        mode = cycle(mode);
        try {
          localStorage.setItem(STORAGE_KEY, mode);
        } catch {}
        apply(mode);
      });
    })();
  </script>
</header>
