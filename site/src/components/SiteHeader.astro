---
type Props = {
  currentPath?: string;
};

const { currentPath } = Astro.props;
const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

const nav = [
  { href: `${base}`, label: "Home", key: "/" },
  { href: `${base}browse/`, label: "Explore poems", key: "/browse" },
  { href: `${base}search/`, label: "Search", key: "/search" },
];

const normalized = (p?: string) => {
  if (!p) return "";
  // remove trailing slash (except root)
  if (p.length > 1 && p.endsWith("/")) return p.slice(0, -1);
  return p;
};

const here = normalized(currentPath);
---

<header class="header">
  <div class="brand">
    <a href={`${base}`}>
      <div class="brand-title">Freeverse</div>
      <div class="brand-subtitle">Public-domain poetry, pleasantly readable</div>
      <div class="brand-motto">
        <a href={`${base}share/horace/odes-3-30-exegi-monumentum/6-6/`}>Non omnis moriar</a>
      </div>
    </a>
  </div>

  <nav class="nav" aria-label="Primary">
    {nav.map((item) => (
      <a href={item.href} aria-current={here === item.key ? "page" : undefined}>
        {item.label}
      </a>
    ))}

    <button class="theme-toggle" type="button" data-theme-toggle aria-label="Toggle theme">
      Theme
    </button>
  </nav>

  <button
    class="menu-toggle"
    type="button"
    id="menu-toggle"
    aria-haspopup="true"
    aria-expanded="false"
    aria-controls="mobile-menu"
  >
    Menu
  </button>

  <div class="mobile-menu" id="mobile-menu" hidden>
    <nav class="mobile-nav" aria-label="Primary">
      {nav.map((item) => (
        <a href={item.href} aria-current={here === item.key ? "page" : undefined}>
          {item.label}
        </a>
      ))}
    </nav>

    <button class="theme-toggle" type="button" data-theme-toggle aria-label="Toggle theme">
      Theme
    </button>
  </div>

  <script is:inline>
    (() => {
      const STORAGE_KEY = 'freeverse-theme';

      const toggleButtons = Array.from(document.querySelectorAll('[data-theme-toggle]'));
      const menuBtn = document.getElementById('menu-toggle');
      const menu = document.getElementById('mobile-menu');

      const applyTheme = (mode) => {
        const root = document.documentElement;
        if (mode === 'light' || mode === 'dark') root.dataset.theme = mode;
        else delete root.dataset.theme;

        const label = mode === 'system' ? 'System' : mode[0].toUpperCase() + mode.slice(1);
        for (const btn of toggleButtons) btn.textContent = `Theme: ${label}`;
      };

      const getStored = () => {
        try {
          return localStorage.getItem(STORAGE_KEY) || 'system';
        } catch {
          return 'system';
        }
      };

      const cycleTheme = (mode) => {
        if (mode === 'system') return 'light';
        if (mode === 'light') return 'dark';
        return 'system';
      };

      let mode = getStored();
      applyTheme(mode);

      for (const btn of toggleButtons) {
        btn.addEventListener('click', () => {
          mode = cycleTheme(mode);
          try {
            localStorage.setItem(STORAGE_KEY, mode);
          } catch {}
          applyTheme(mode);
        });
      }

      if (menuBtn && menu) {
        const close = () => {
          menu.hidden = true;
          menuBtn.setAttribute('aria-expanded', 'false');
        };

        menuBtn.addEventListener('click', () => {
          const isOpen = menu.hidden === false;
          menu.hidden = isOpen;
          menuBtn.setAttribute('aria-expanded', String(!isOpen));
        });

        document.addEventListener('click', (e) => {
          if (menu.hidden) return;
          const t = e.target;
          if (!(t instanceof Node)) return;
          if (menu.contains(t) || menuBtn.contains(t)) return;
          close();
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close();
        });
      }
    })();
  </script>
</header>
