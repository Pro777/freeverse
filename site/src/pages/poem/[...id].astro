---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { loadPoemMetas, loadPoemText, type PoemMeta } from "../../lib/poems";

export async function getStaticPaths() {
  const poems = await loadPoemMetas();
  return poems.map((p) => ({
    // For rest params, Astro expects a single string that may contain slashes.
    params: { id: p.id },
    props: { poem: p },
  }));
}

type Props = { poem: PoemMeta };

const { poem } = Astro.props;
const raw = await loadPoemText(poem);
const lines = raw ? raw.split(/\r?\n/) : [];

const title = `${poem.title} · Freeverse`;
const description = `Read ${poem.title} by ${poem.author}.`;

const base = import.meta.env.BASE_URL;
const canonicalPath = `${base}poem/${poem.id}/`;
---

<BaseLayout title={title} description={description} currentPath={""}>
  <article class="reader">
    <header class="reader-head">
      <h1 class="reader-title">{poem.title}</h1>
      <p class="reader-byline">
        <span class="muted">by</span> <strong>{poem.author}</strong>
        <span class="muted" style="margin: 0 0.35rem;">·</span>
        <a class="muted" href={`${base}browse/`}>Explore poems</a>
      </p>
    </header>

    {raw ? (
      <ol class="poem-lines">
        {lines.map((line, idx) => {
          const n = idx + 1;
          const id = `l${n}`;
          return (
            <li id={id}>
              <a class="line-anchor" href={`${canonicalPath}#${id}`} aria-label={`Link to line ${n}`}>¶</a>
              <span class="line-text">{line === "" ? "\u00A0" : line}</span>
            </li>
          );
        })}
      </ol>
    ) : (
      <div class="card">
        <p class="muted" style="margin:0;">
          Poem text isn’t in the repository yet.
          {poem.source_url ? (
            <>
              {" "}Try the source: <a href={poem.source_url}>{poem.source_label ?? poem.source_url}</a>.
            </>
          ) : null}
        </p>
      </div>
    )}

    <footer class="reader-foot muted">
      <p style="margin:0.9rem 0 0;">
        Tip: click a line number to share that line — or shift-click another line to share a range.
      </p>
    </footer>

    <script is:inline>
      (() => {
        const lines = Array.from(document.querySelectorAll('.poem-lines li'));
        if (!lines.length) return;

        const clear = () => {
          lines.forEach((li) => li.classList.remove('is-selected'));
        };

        const parseHash = () => {
          const h = (location.hash || '').replace(/^#/, '');
          if (!h) return null;

          const m = h.match(/^l(\d+)(?:-l(\d+))?$/);
          if (!m) return null;

          const a = Number(m[1]);
          const b = m[2] ? Number(m[2]) : a;
          if (!Number.isFinite(a) || !Number.isFinite(b)) return null;

          const start = Math.min(a, b);
          const end = Math.max(a, b);
          return { start, end };
        };

        const applyFromHash = () => {
          clear();
          const r = parseHash();
          if (!r) return;
          for (let n = r.start; n <= r.end; n++) {
            const el = document.getElementById(`l${n}`);
            if (el) el.classList.add('is-selected');
          }
        };

        // Keep UI in sync when navigating back/forward.
        window.addEventListener('hashchange', applyFromHash);
        applyFromHash();

        let startLine = null;

        const setHash = (start, end) => {
          const fragment = start === end ? `#l${start}` : `#l${start}-l${end}`;
          history.replaceState(null, '', fragment);
          applyFromHash();
        };

        document.addEventListener('click', (e) => {
          const a = e.target && e.target.closest ? e.target.closest('a.line-anchor') : null;
          if (!a) return;

          const li = a.closest('li');
          if (!li || !li.id) return;

          // Prevent default so we can control the hash format (single vs range).
          e.preventDefault();

          const n = Number(li.id.replace(/^l/, ''));
          if (!Number.isFinite(n)) return;

          if (e.shiftKey && startLine != null) {
            setHash(startLine, n);
          } else {
            startLine = n;
            setHash(n, n);
          }
        });
      })();
    </script>
  </article>
</BaseLayout>
